CREATE EXTENSION postgis;

CREATE TABLE users (
	id BIGSERIAL PRIMARY KEY,
	name VARCHAR NOT NULL,
	email VARCHAR NOT NULL
);

CREATE TABLE source_routes (
	id BIGSERIAL PRIMARY KEY,
	gpx XML
);

CREATE SEQUENCE route_id_seq START 1;

CREATE TABLE points (
	geom GEOGRAPHY(POINT,4326) NOT NULL,
	route_id BIGINT NOT NULL,
	ts TIMESTAMPTZ NOT NULL,
	ele DOUBLE PRECISION NOT NULL,
	PRIMARY KEY (route_id, geom)
);

CREATE TABLE segments (
	id BIGSERIAL PRIMARY KEY,
	name VARCHAR NOT NULL,
	route_id BIGINT NOT NULL,
	source_id BIGINT REFERENCES source_routes(id) NOT NULL,
	geom GEOGRAPHY(LINESTRING,4326) DEFAULT NULL,
	geom_expanded GEOGRAPHY(POLYGON,4326) DEFAULT NULL
);

CREATE TABLE events (
	id BIGSERIAL PRIMARY KEY,
	name VARCHAR NOT NULL
);

CREATE TABLE event_segments (
	event_id BIGINT REFERENCES events(id) ON UPDATE CASCADE ON DELETE CASCADE,
	segment_id BIGINT REFERENCES segments(id) ON UPDATE CASCADE,
	CONSTRAINT event_segments_pkey PRIMARY KEY (event_id, segment_id)
);

CREATE TABLE participations (
	id BIGSERIAL PRIMARY KEY,
	event_id BIGINT REFERENCES events(id) NOT NULL,
	user_id BIGINT REFERENCES users(id) NOT NULL,
	route_id BIGINT NOT NULL,
	source_id BIGINT REFERENCES source_routes(id) NOT NULL,
	total_elapsed_seconds BIGINT DEFAULT 0,
	geom GEOGRAPHY(LINESTRING,4326) DEFAULT NULL
);

CREATE TABLE participation_segments (
	participation_id BIGINT REFERENCES participations(id) ON UPDATE CASCADE ON DELETE CASCADE,
	segment_id BIGINT REFERENCES segments(id) ON UPDATE CASCADE,
	elapsed_seconds BIGINT DEFAULT NULL,
	geom GEOGRAPHY DEFAULT NULL,
	PRIMARY KEY (participation_id, segment_id)
);